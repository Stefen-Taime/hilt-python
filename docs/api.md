# API Reference

## Table of Contents

1. [Core Classes](#core-classes)
   - [Event](#event)
   - [Actor](#actor)
   - [Content](#content)
   - [Metrics](#metrics)
   - [Privacy](#privacy)
2. [Sessions](#sessions)
3. [Converters](#converters)
4. [Utilities](#utilities)

## Core Classes

### Event

Represents a single interaction in a session.

**Attributes**

- `hilt_version: str` – Format version (default `1.0.0`).
- `event_id: str` – UUID (autogenerated via `generate_event_id`).
- `timestamp: str` – ISO 8601 timestamp (UTC).
- `session_id: str` – Conversation identifier.
- `actor: Actor` – Entity performing the action.
- `action: str` – One of `prompt`, `completion`, `tool_call`, `tool_result`, `feedback`, `retrieval`, `rerank`, `embedding`, `system`.
- `content: Content | None` – Payload data.
- `provenance: dict | None` – Source metadata (model, tools, chain IDs).
- `metrics: Metrics | None` – Latency, tokens, costs, etc.
- `privacy: Privacy | None` – GDPR/PII information.
- `integrity: dict | None` – Signatures, hashes.
- `extensions: dict | None` – Custom fields.

**Methods**

- `to_dict() -> dict` – Serialize to Python dict.
- `to_json() -> str` – Serialize to JSON string.
- `from_dict(data: dict) -> Event` – Construct from dict.
- `from_json(data: str) -> Event` – Construct from JSON string.

**Example**

```python
from hilt import Event, Actor, Content

event = Event(
    session_id="chat-42",
    actor=Actor(type="human", id="alice"),
    action="prompt",
    content=Content(text="Translate hello to French")
)
print(event.to_json())
```

### Actor

Describes the source of an event.

| Field | Type | Description |
|-------|------|-------------|
| `type` | `str` | `human`, `agent`, `tool`, or `system`. |
| `id` | `str` | Unique identifier (user ID, model name). |
| `did` | `str | None` | Decentralized identifier (optional). |

### Content

Flexible payload container.

- `text: str | None`
- `text_hash: str | None`
- `text_encrypted: str | None`
- `media: list[dict]` – Attachments, embeddings, JSON schema, etc.

### Metrics

Quantitative telemetry.

- `latency_ms: int | None`
- `tokens: dict[str, int] | None` (e.g., `{"prompt": 10, "completion": 20}`)
- `cost_usd: float | None`

### Privacy

Tracks privacy information and consent.

- `pii_detected: list[str]`
- `redaction_applied: bool`
- `consent: dict | None`

## Sessions

### `Session`

Context manager for reading/writing JSONL logs.

```python
from hilt import Session, Event, Actor

with Session("logs/app.hilt.jsonl") as session:
    session.append(Event(session_id="1", actor=Actor(type="human", id="u"), action="prompt"))

reader = Session("logs/app.hilt.jsonl", mode="r")
for event in reader.read():
    print(event.session_id)
```

**Parameters**

- `filepath: str | Path`
- `mode: str` – `"a"` (append) by default, or `"r"` for read.
- `create_dirs: bool` – Create parent directories when writing.
- `encoding: str` – Default `utf-8`.

**Methods**

- `append(event: Event) -> None`
- `read() -> Iterator[Event]`
- `open()` / `close()` – Manual control outside context manager.

## Converters

### CSV

```python
from hilt.converters.csv import convert_to_csv

convert_to_csv(
    input_file="logs/app.hilt.jsonl",
    output_file="logs/app.csv",
    columns=["event_id", "timestamp", "actor.type", "actor.id", "action"]
)
```

Features:

- Dot-notation flattening (`actor.type`, `metrics.tokens.total`).
- Arrays serialized as semicolon-separated (simple) or JSON.
- Optional column selection.

### Parquet

```python
from hilt.converters.parquet import convert_to_parquet

convert_to_parquet(
    input_file="logs/app.hilt.jsonl",
    output_file="logs/app.parquet",
    compression="snappy"
)
```

Features:

- Uses PyArrow schema (strings, timestamps, numeric metrics).
- Batch streaming to avoid loading entire file in memory.
- Supports `snappy`, `gzip`, or `none` compression.

## Utilities

```python
from hilt.utils import generate_event_id, now_iso8601, parse_timestamp,
    hash_content, verify_hash

event_id = generate_event_id()
timestamp = now_iso8601()
dt = parse_timestamp(timestamp)
digest = hash_content("Hello")
assert verify_hash("Hello", digest)
```

- `generate_event_id()` – UUIDv7 (fallback UUID4) string.
- `now_iso8601()` – Current UTC time with millisecond precision (`...Z`).
- `parse_timestamp(ts)` – Parse ISO 8601 string into timezone-aware `datetime`.
- `hash_content(text)` – Return `sha256:<digest>`.
- `verify_hash(text, digest)` – Validate hash string (raises if prefix invalid).
